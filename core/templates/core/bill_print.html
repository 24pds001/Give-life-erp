{% extends 'core/base.html' %}
{% load static %}
{% load permission_tags %}

{% block title %}Invoice {{ bill.invoice_number }}{% endblock %}

{% block content %}
<style>
    :root {
        --primary-color: #2c5282;
        /* Deep Blue */
        --secondary-color: #f7fafc;
        /* Light Gray */
        --accent-color: #4299e1;
        /* Lighter Blue */
        --text-color: #2d3748;
        --border-color: #e2e8f0;
    }

    body {
        background-color: #edf2f7;
        color: var(--text-color);
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    #invoice-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        max-width: 900px;
        margin: 2rem auto;
        border: 1px solid var(--border-color);
    }

    .bill-header {
        padding: 2.5rem;
        border-bottom: 2px solid var(--secondary-color);
    }

    .cafe-logo-area {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .cafe-logo-cancel {
        width: 80px;
        height: 80px;
        background: #e2e8f0;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: var(--primary-color);
    }

    .cafe-details h1 {
        font-size: 1.75rem;
        color: #3182ce;
        /* Bright Blue Title */
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .cafe-details p {
        color: #718096;
        margin-bottom: 0.15rem;
        font-size: 0.95rem;
    }

    .invoice-badge-container {
        text-align: right;
    }

    .premium-box {
        background: #ebf8ff;
        /* Light Blue Background */
        border: 1px solid #bee3f8;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .invoice-box {
        display: inline-block;
        min-width: 200px;
        text-align: right;
    }

    .invoice-title {
        font-size: 1.1rem;
        font-weight: 800;
        letter-spacing: 0.5px;
        color: #2b6cb0;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
    }

    .invoice-detail {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
        color: #4a5568;
    }

    .invoice-detail strong {
        color: #2d3748;
    }

    /* Common Tab Header Style */
    .common-header-tab {
        background-color: #6c8aa8;
        /* Muted Blue for Headers */
        color: white;
        padding: 0.5rem 1rem;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        border-top-left-radius: 6px;
        border-top-right-radius: 12px;
        clip-path: polygon(0 0, 95% 0, 100% 100%, 0% 100%);
        width: fit-content;
        min-width: 150px;
        margin-bottom: 0.5rem;
    }

    .common-box {
        background: #f8fafc;
        /* Very light gray/white */
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 0;
        height: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        text-align: left;
        /* Default alignment */
    }

    .common-box-content {
        padding: 1rem 1.5rem;
        flex-grow: 1;
    }

    .info-container {
        padding: 0 2.5rem 2rem 2.5rem;
    }

    .customer-name {
        font-size: 1.2rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }

    .customer-info p {
        color: #718096;
        margin-bottom: 0.25rem;
        font-size: 0.95rem;
    }

    .payment-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }

    .payment-row i,
    .payment-row svg {
        color: #db9e36;
        /* Icon color */
        width: 20px;
        margin-right: 0.5rem;
    }

    .payment-icon-blue {
        color: #4299e1 !important;
    }

    .items-table-container {
        padding: 0 2.5rem;
        margin-bottom: 2rem;
    }

    .custom-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .custom-table th {
        background-color: #edf2f7;
        color: #4a5568;
        font-weight: 700;
        text-transform: uppercase;
        font-size: 0.8rem;
        padding: 0.75rem 1rem;
        border-bottom: 2px solid #cbd5e0;
        text-align: left;
    }

    .custom-table th:first-child {
        border-top-left-radius: 6px;
    }

    .custom-table th:last-child {
        border-top-right-radius: 6px;
        text-align: right;
    }

    .custom-table th.center {
        text-align: center;
    }

    .custom-table td {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #e2e8f0;
        color: #2d3748;
        vertical-align: middle;
    }

    .custom-table td:last-child {
        text-align: right;
        font-weight: 600;
    }

    .custom-table td.center {
        text-align: center;
    }

    .custom-table tbody tr:last-child td {
        border-bottom: 2px solid #e2e8f0;
    }

    .total-row td {
        background-color: #f7fafc;
        font-weight: 700;
        color: #2d3748;
        border-bottom: none !important;
        font-size: 1.1rem;
        padding-top: 1rem;
        padding-bottom: 1rem;
    }

    .subtotal-row td {
        border-bottom: none !important;
        padding-top: 0.5rem;
        padding-bottom: 0.5rem;
        color: #718096;
    }

    .footer-section {
        padding: 1rem 2.5rem 3rem 2.5rem;
        margin-top: 1rem;
    }

    .remarks-box {
        color: #4a5568;
    }

    .remarks-label {
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .signature-box {
        text-align: right;
        padding-top: 2rem;
    }

    .signature-font {
        font-family: 'Brush Script MT', cursive;
        font-size: 1.5rem;
        color: #2d3748;
        margin-bottom: 0.5rem;
    }

    .generated-by {
        font-size: 0.85rem;
        color: #a0aec0;
    }

    /* Print Specifics */
    @media print {
        @page {
            size: A5;
            margin: 0.5cm;
        }

        body {
            background: white;
            margin: 0;
            padding: 0;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
            font-size: 10pt;
        }

        /* Hide Sidebar, Navbar, and other non-print elements from base.html */
        .sidebar,
        .navbar,
        .btn,
        .d-print-none,
        #sidebarToggle,
        .dropdown {
            display: none !important;
        }

        /* Reset Main Content wrappers */
        .wrapper,
        .main-content {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            background: white !important;
            display: block !important;
        }

        /* Invoice Card Reset */
        #invoice-card {
            box-shadow: none !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
            border-radius: 0 !important;
        }

        /* Compact Layout for A5 */
        .bill-header {
            padding: 1rem !important;
            border-bottom: 1px solid #000 !important;
        }

        .cafe-logo-cancel {
            width: 50px;
            height: 50px;
            font-size: 1.5rem;
        }

        .cafe-details h1 {
            font-size: 1.25rem !important;
            color: #000 !important;
        }

        .cafe-details p {
            color: #333 !important;
            font-size: 0.8rem !important;
        }

        .info-container {
            padding: 1rem !important;
        }

        .common-box {
            border: 1px solid #ccc !important;
            background: white !important;
        }

        .common-header-tab {
            /* Restoring original styling by removing specific print overrides */
            padding: 0.15rem 0.5rem !important;
            font-size: 8pt !important;
        }

        .common-box-content {
            padding: 0.4rem 0.8rem !important;
        }

        .items-table-container {
            padding: 0 1rem !important;
            margin-bottom: 0.25rem !important;
        }

        .custom-table th {
            padding: 0.35rem !important;
            font-size: 8pt !important;
        }

        .custom-table td {
            padding: 0.35rem !important;
            font-size: 8.5pt !important;
        }

        .total-row td,
        .subtotal-row td {
            padding-top: 0.15rem !important;
            padding-bottom: 0.15rem !important;
        }

        .footer-section {
            padding: 0.25rem 1rem 0.5rem 1rem !important;
            margin-top: 0 !important;
        }

        .signature-box {
            padding-top: 0.5rem !important;
        }

        /* Specific text resizing for A5 */
        .cafe-details h1 {
            font-size: 14pt !important;
            margin-bottom: 0 !important;
        }

        .cafe-details p {
            font-size: 8pt !important;
        }

        .customer-name {
            font-size: 11pt !important;
            margin-bottom: 0.1rem !important;
        }

        .invoice-title {
            font-size: 10pt !important;
        }

        .invoice-detail {
            font-size: 8pt !important;
        }

        .payment-row {
            font-size: 8.5pt !important;
        }

        .remarks-box p {
            font-size: 8pt !important;
        }
    }
</style>

<!-- Main Container -->
<div class="container-fluid" style="min-height: 100vh;">
    <div id="invoice-card">

        <!-- Header -->
        <div class="bill-header">
            <div class="row align-items-center">
                <div class="col-7">
                    <div class="cafe-logo-area">
                        <!-- Placeholder specific logo/icon if needed, using a generic cup icon here from Bootstrap Icons or similar if available, else CSS circle -->
                        <!-- If user has image asset, we could use it. For now, matching the 'style' of the image with a graphic placeholder or just text -->
                        <div class="cafe-logo-cancel d-none d-sm-flex">
                            <i class="bi bi-cup-hot-fill"></i>
                        </div>
                        <div class="cafe-details">
                            <h1>Loyola Give Life Cafe</h1>
                            <p>Loyola College, Chennai-34.</p>
                            <p>Email Id : givelife@loyolacollege.edu</p>
                        </div>
                    </div>
                </div>
                <div class="col-5">
                    <div class="invoice-badge-container">
                        <div class="common-box shadow-sm">
                            <div class="common-header-tab">INVOICE</div>
                            <div class="common-box-content" style="text-align: left;">
                                <div class="invoice-detail"><strong>Invoice No:</strong> {{ bill.invoice_number }}</div>
                                <div class="invoice-detail"><strong>Date:</strong> {{ bill.created_at|date:"d M Y, h:i A" }}
                                </div>
                                <div class="invoice-detail"><strong>Type:</strong> {{ bill.get_bill_type_display }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Info Grid -->
        <div class="info-container">
            <div class="row g-4">
                <!-- Bill To Section -->
                <div class="col-7">
                    <div class="common-box h-75">
                        <div class="common-header-tab">BILL TO</div>
                        <div class="common-box-content">
                            <div class="customer-info">
                                {% if bill.customer %}
                                <div class="customer-name">{{ bill.customer.customer_name }}</div>
                                <p>{{ bill.customer.address|linebreaksbr }}</p>
                                <p>{{ bill.customer.contact_number }}</p>
                                {% else %}
                                <div class="customer-name">{{ bill.customer_name }}</div>
                                <p>{{ bill.customer_address|linebreaksbr }}</p>
                                {% endif %}

                                {% if bill.outlet_name %}
                                <p class="mt-2 text-dark"><strong>Outlet:</strong> {{ bill.get_outlet_name_display }}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment Details Section -->
                <div class="col-5">
                    <div class="common-box h-100">
                        <div class="common-header-tab">PAYMENT DETAILS</div>
                        <!-- Using Invoice Blue for Tab -->

                        <div class="common-box-content">
                            <div class="payment-row">
                                <span>Status: </span>
                                <span
                                    class="ms-2 fw-bold {% if bill.payment_status == 'PAID' %}text-success{% else %}text-warning{% endif %}">
                                    {{ bill.get_payment_status_display }}
                                </span>
                            </div>

                            {% if bill.payment_status == 'PAID' or bill.advance_payment > 0 %}
                            <div class="payment-row">
                                <span>Mode: </span>
                                <span class="ms-2 fw-bold">
                                    {% with payments=bill.payments.all %}
                                    {% if payments %}
                                    {% for p in payments %}
                                    <span>{{ p.get_payment_type_display }}: ₹{{ p.amount }}{% if not forloop.last %}, {% endif %}</span>
                                    {% endfor %}
                                    {% else %}
                                    {{ bill.get_payment_type_display }}
                                    {% endif %}
                                    {% endwith %}
                                </span>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Table -->
        <div class="items-table-container">
            <table class="custom-table">
                <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th>ITEM DESCRIPTION</th>
                        <th class="center" style="width: 100px;">QTY</th>
                        <th class="text-end" style="width: 120px;">PRICE</th>
                        <th class="text-end" style="width: 120px;">TOTAL</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in bill.items.all %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            {% if item.item %}
                            {{ item.item.name }}
                            {% else %}
                            {{ item.custom_item_name }}
                            {% endif %}
                        </td>
                        <td class="center">{{ item.quantity }}</td>
                        <td class="text-end">₹{{ item.price }}</td>
                        <td class="text-end">₹{{ item.total }}</td>
                    </tr>
                    {% endfor %}

                    <!-- Spacer Row if needed or just empty space handled by padding -->
                </tbody>
                <tfoot>
                    {% if bill.advance_payment > 0 %}
                    <tr class="subtotal-row">
                        <td colspan="4" class="text-end">Total Amount</td>
                        <td class="text-end">₹{{ bill.total_amount }}</td>
                    </tr>
                    <tr class="subtotal-row">
                        <td colspan="4" class="text-end">
                            Advance Paid (
                            {% if bill.get_advance_payment_type_display %}
                            {{ bill.get_advance_payment_type_display }}
                            {% else %}
                            {{ bill.get_payment_type_display }}
                            {% endif %}
                            )
                        </td>
                        <td class="text-end text-muted">- ₹{{ bill.advance_payment }}</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="4" class="text-end">
                            {% if bill.payment_status == 'PAID' %}Balance Paid{% else %}Balance Due{% endif %}
                        </td>
                        <td
                            class="text-end {% if bill.payment_status == 'PAID' %}text-success{% else %}text-danger{% endif %}">
                            ₹{{ bill.balance_due }}</td>
                    </tr>
                    {% else %}
                    <tr class="total-row">
                        <td colspan="4" class="text-end">Total</td>
                        <td class="text-end">₹{{ bill.total_amount }}</td>
                    </tr>
                    {% endif %}
                </tfoot>
            </table>
        </div>

        <!-- Footer -->
        <div class="footer-section">
            <hr class="mb-4" style="border-top: 1px solid #e2e8f0; opacity: 1;">
            <div class="row">
                <div class="col-6">
                    <div class="remarks-box">
                        <div class="remarks-label">Remarks:</div>
                        <p class="small">{{ bill.remarks|default:"--" }}</p>
                    </div>
                </div>
                <div class="col-6">
                    <div class="signature-box">
                        <div class="signature-font">Authorized Signature</div>
                        <div class="generated-by">Generated by: {{ bill.created_by.username }}</div>
                        <div class="generated-by mt-1">Printed on: <span id="print-time-display"></span></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var now = new Date();
            var options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            document.getElementById('print-time-display').textContent = now.toLocaleDateString('en-US', options);
        });
    </script>

    <!-- Print Actions -->
    <div class="text-center mt-4 mb-5 d-print-none">
        <button onclick="window.print()" class="btn btn-primary btn-lg px-5 rounded-pill shadow-sm">
            <i class="bi bi-printer me-2"></i>Print Invoice
        </button>

        {% has_bill_permission user bill 'edit' as can_edit %}
        {% if can_edit %}
        <a href="{% url 'edit_bill' bill.id %}" class="btn btn-warning btn-lg px-4 ms-2 rounded-pill shadow-sm">
            <i class="bi bi-pencil me-2"></i>Modify
        </a>
        {% endif %}

        <a href="{% url 'billing_home' %}" class="btn btn-light border btn-lg px-4 ms-2 rounded-pill shadow-sm">Back</a>
    </div>
</div>
{% endblock %}